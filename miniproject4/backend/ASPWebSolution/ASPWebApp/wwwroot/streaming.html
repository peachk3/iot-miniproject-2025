<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Python AI Streaming Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body class="d-flex justify-content-center align-items-center vh-100">
    <div class="card" style="width: 680px;">
        <div align="center">
            <img id="cameraView" class="card-img-top" width="100%" heigh="100%">
        </div>
        <div class="card-body">
            <h5 class="card-title">물체인식Python AI Streaming Example</h5>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const broker = 'ws://localhost:9001';
        const topic = '/aiserver/objectdetects';

        const client = mqtt.connect(broker);

        client.on("connect", () => {
            console.log("Connected to broker");
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log(`Subscibed to topic: ${topic}`);
                }
            })
        })

        client.on("message", (topic, message) => {
            try {
                const payload = JSON.parse(message.toString());
                const base64Image = payload.image;
                const img = document.getElementById("cameraView")
                img.src = `data:image/jpg;base64,${base64Image}`;
            } catch (e) {
                console.error('Failed to parse message: ', e);
            }
        })

        client.on("error", (error) => {
            console.error("connection error: ", error);
        })

        client.on("close", () => {
            console.log("Disconnected from broker");
        })
    </script>
</body>
</html>